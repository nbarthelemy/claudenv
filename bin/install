#!/bin/bash
# Claudenv Installer
# Usage: curl -sL https://raw.githubusercontent.com/nbarthelemy/claudenv/main/bin/install | bash
#   or:  /path/to/claudenv/bin/install

set -e

REPO_URL="https://github.com/nbarthelemy/claudenv"
BRANCH="main"
TARGET=".claude"

# Check for workspace setup (parent .claude with claudenv)
WORKSPACE_ROOT=""
IS_SUBPROJECT=false
check_dir="$PWD"
while [ "$check_dir" != "/" ]; do
    parent_dir=$(dirname "$check_dir")
    if [ -f "$parent_dir/.claude/version.json" ]; then
        WORKSPACE_ROOT="$parent_dir/.claude"
        IS_SUBPROJECT=true
        break
    fi
    check_dir="$parent_dir"
done

# Check if running from local repo
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" 2>/dev/null && pwd)"
if [ -d "$SCRIPT_DIR/../dist" ]; then
    LOCAL_INSTALL=true
    DIST="$SCRIPT_DIR/../dist"
else
    LOCAL_INSTALL=false
fi

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "  Claudenv Installer"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Report workspace detection
if [ "$IS_SUBPROJECT" = true ]; then
    echo ""
    echo "ğŸ“ Workspace detected: $WORKSPACE_ROOT"
    echo "   Installing subproject config (inherits core skills from workspace)"
fi

# Check for existing .claude directory
EXISTING_CLAUDE_MD=""
IS_UPDATE=false
if [ -d "$TARGET" ]; then
    IS_UPDATE=true
    echo ""
    echo "Found existing .claude directory"

    # Preserve existing CLAUDE.md content
    if [ -f "$TARGET/CLAUDE.md" ]; then
        EXISTING_CLAUDE_MD=$(cat "$TARGET/CLAUDE.md")
        echo "  - Will preserve your CLAUDE.md content"
    fi

    # Backup existing settings.local.json
    if [ -f "$TARGET/settings.local.json" ]; then
        cp "$TARGET/settings.local.json" /tmp/claudenv-settings-local.json.bak
        echo "  - Will preserve settings.local.json"
    fi

    # Note about custom content
    echo "  - Will preserve custom skills, commands, and agents"

    echo ""
    read -p "Update claudenv infrastructure? (y/N): " CONFIRM
    if [[ ! "$CONFIRM" =~ ^[Yy]$ ]]; then
        echo "Installation cancelled"
        exit 1
    fi
fi

# Download if not local install
if [ "$LOCAL_INSTALL" = false ]; then
    echo ""
    echo "Downloading Claudenv..."

    # Create temp directory
    TEMP_DIR=$(mktemp -d)
    trap "rm -rf $TEMP_DIR" EXIT

    # Download and extract
    if command -v curl &> /dev/null; then
        curl -sL "${REPO_URL}/archive/refs/heads/${BRANCH}.tar.gz" | tar -xz -C "$TEMP_DIR"
    elif command -v wget &> /dev/null; then
        wget -qO- "${REPO_URL}/archive/refs/heads/${BRANCH}.tar.gz" | tar -xz -C "$TEMP_DIR"
    else
        echo "Error: curl or wget required"
        exit 1
    fi

    DIST="$TEMP_DIR/claudenv-${BRANCH}/dist"
fi

# Verify manifest exists
if [ ! -f "$DIST/manifest.json" ]; then
    echo "Error: Missing manifest.json"
    exit 1
fi

# Create .claude directory if it doesn't exist
mkdir -p "$TARGET"

echo "Installing claudenv framework..."

# If updating, remove deprecated files first
if [ "$IS_UPDATE" = true ] && [ -f "$TARGET/manifest.json" ]; then
    # Remove files that are in OLD manifest but not in NEW manifest (deprecated)
    if command -v jq &> /dev/null; then
        while IFS= read -r file; do
            if [ -f "$TARGET/$file" ]; then
                rm -f "$TARGET/$file"
            fi
        done < <(jq -r '.deprecated[]' "$DIST/manifest.json" 2>/dev/null)
    fi
fi

# Framework directories that should only exist at workspace root (not in subprojects)
FRAMEWORK_DIRS="skills commands rules scripts templates agents orchestration"

# Copy framework files using manifest (preserves custom content)
if command -v jq &> /dev/null; then
    # Use manifest-based copy (preferred)
    while IFS= read -r file; do
        if [ -f "$DIST/$file" ]; then
            # Skip framework directories for subprojects (they inherit from workspace root)
            if [ "$IS_SUBPROJECT" = true ]; then
                skip=false
                for dir in $FRAMEWORK_DIRS; do
                    if [[ "$file" == ${dir}/* ]]; then
                        skip=true
                        break
                    fi
                done
                if [ "$skip" = true ]; then
                    continue
                fi
            fi
            mkdir -p "$TARGET/$(dirname "$file")"
            cp "$DIST/$file" "$TARGET/$file"
        fi
    done < <(jq -r '.files[]' "$DIST/manifest.json" 2>/dev/null)
else
    # Fallback: copy all files but merge directories (don't delete)
    echo "  Note: Install jq for better custom content preservation"
    for dir in commands skills rules scripts templates learning agents orchestration; do
        # Skip framework dirs for subprojects
        if [ "$IS_SUBPROJECT" = true ]; then
            skip=false
            for fdir in $FRAMEWORK_DIRS; do
                if [ "$dir" = "$fdir" ]; then
                    skip=true
                    break
                fi
            done
            if [ "$skip" = true ]; then
                continue
            fi
        fi
        if [ -d "$DIST/$dir" ]; then
            mkdir -p "$TARGET/$dir"
            cp -r "$DIST/$dir"/* "$TARGET/$dir"/ 2>/dev/null || true
        fi
    done
fi

# Copy config files (always overwrite framework configs)
cp "$DIST/settings.json" "$TARGET/settings.json"
cp "$DIST/version.json" "$TARGET/version.json"
cp "$DIST/manifest.json" "$TARGET/manifest.json"
[ -f "$DIST/settings.local.json.template" ] && cp "$DIST/settings.local.json.template" "$TARGET/settings.local.json.template"

# Restore settings.local.json if it was backed up
if [ -f /tmp/claudenv-settings-local.json.bak ]; then
    mv /tmp/claudenv-settings-local.json.bak "$TARGET/settings.local.json"
fi

# Create empty directories for user data
mkdir -p "$TARGET/logs"
mkdir -p "$TARGET/backups"
mkdir -p "$TARGET/loop"
mkdir -p "$TARGET/plans"
mkdir -p "$TARGET/rca"
mkdir -p "$TARGET/references"

# Make scripts executable
chmod +x "$TARGET/scripts/"*.sh 2>/dev/null || true

# Migration: v4.x â†’ v5.x (unified hooks)
if [ "$IS_UPDATE" = true ]; then
    # Detect old 3-hook settings pattern and clean up deprecated scripts
    if [ -f "$TARGET/scripts/code-gate.sh" ] && [ -f "$TARGET/scripts/unified-gate.sh" ]; then
        echo "  - Migrating hooks: 3-hook â†’ unified-gate"
        rm -f "$TARGET/scripts/code-gate.sh"
        rm -f "$TARGET/scripts/focus-enforce.sh"
        rm -f "$TARGET/scripts/read-before-write.sh"
        rm -f "$TARGET/scripts/tdd-enforce.sh"
        rm -f "$TARGET/scripts/todo-coordinator.sh"
        rm -f "$TARGET/scripts/decision-reminder.sh"
        rm -f "$TARGET/scripts/learning-observer.sh"
    fi
    # Clean up deleted rule files
    rm -f "$TARGET/rules/parallel-execution.md"
    rm -f "$TARGET/rules/error-recovery/core.md"
    rm -f "$TARGET/rules/documentation.md"
fi

# Handle CLAUDE.md - preserve user content, add claudenv import
if [ -n "$EXISTING_CLAUDE_MD" ]; then
    # Check if already has claudenv import
    if echo "$EXISTING_CLAUDE_MD" | grep -q "@rules/claudenv.md"; then
        # Already has import, just restore the file
        echo "$EXISTING_CLAUDE_MD" > "$TARGET/CLAUDE.md"
    else
        # Add claudenv import to existing content
        cat > "$TARGET/CLAUDE.md" << EOF
$EXISTING_CLAUDE_MD

## Claudenv Framework

@rules/claudenv.md
EOF
    fi
    echo "  - Preserved your CLAUDE.md, added framework import"
else
    # Create new CLAUDE.md with import
    cat > "$TARGET/CLAUDE.md" << 'EOF'
# Project Instructions

<!-- Add your project-specific instructions here -->

## Claudenv Framework

@rules/claudenv.md
EOF
    echo "  - Created CLAUDE.md with framework import"
fi

# Create TODO.md if it doesn't exist (check both .claude and root)
if [ ! -f "$TARGET/TODO.md" ] && [ ! -f "./TODO.md" ]; then
    cp "$DIST/TODO.md" "$TARGET/TODO.md" 2>/dev/null || true
    echo "  - Created TODO.md"
fi

# Count what was installed
LOCAL_SKILLS=$(find "$TARGET/skills" -name "SKILL.md" 2>/dev/null | wc -l | tr -d ' ')
COMMANDS=$(find "$TARGET/commands" -name "*.md" 2>/dev/null | wc -l | tr -d ' ')
AGENTS=$(find "$TARGET/agents" -name "*.md" 2>/dev/null | wc -l | tr -d ' ')

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "  Claudenv Installed!"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
if [ "$IS_SUBPROJECT" = true ]; then
    WORKSPACE_SKILLS=$(find "$WORKSPACE_ROOT/skills" -name "SKILL.md" 2>/dev/null | wc -l | tr -d ' ')
    echo "  ğŸ“ Subproject config installed"
    echo "  Inherits $WORKSPACE_SKILLS skills from workspace root"
    echo "  $LOCAL_SKILLS local skills"
else
    echo "  $LOCAL_SKILLS skills"
fi
echo "  $COMMANDS commands"
echo "  $AGENTS agents"
echo ""
echo "Next steps:"
echo "  1. Start Claude Code: claude"
echo "  2. Run bootstrap: /claudenv"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
