#!/bin/bash
# Claudenv Installer (backward-compatible wrapper)
# Usage: curl -sL https://raw.githubusercontent.com/nbarthelemy/claudenv/main/bin/install | bash
#   or:  /path/to/claudenv/bin/install
#
# This script delegates to `claudenv init`. Kept for backward compatibility.

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" 2>/dev/null && pwd)"

# If running from a local repo checkout, use the CLI directly
if [ -f "$SCRIPT_DIR/claudenv" ]; then
  exec "$SCRIPT_DIR/claudenv" init "$@"
fi

# If piped from curl (no SCRIPT_DIR), fall back to the full installer logic
# This handles: curl -sL .../bin/install | bash

REPO_URL="https://github.com/nbarthelemy/claudenv"
BRANCH="main"
TARGET=".claude"

# Check for workspace setup (parent .claude with claudenv)
WORKSPACE_ROOT=""
IS_SUBPROJECT=false
check_dir="$PWD"
while [ "$check_dir" != "/" ]; do
    parent_dir=$(dirname "$check_dir")
    if [ -f "$parent_dir/.claude/version.json" ]; then
        WORKSPACE_ROOT="$parent_dir/.claude"
        IS_SUBPROJECT=true
        break
    fi
    check_dir="$parent_dir"
done

echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo "  Claudenv Installer"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

if [ "$IS_SUBPROJECT" = true ]; then
    echo ""
    echo "üìÅ Workspace detected: $WORKSPACE_ROOT"
    echo "   Installing subproject config (inherits core skills from workspace)"
fi

# Check for existing .claude directory
EXISTING_CLAUDE_MD=""
IS_UPDATE=false
if [ -d "$TARGET" ]; then
    IS_UPDATE=true
    echo ""
    echo "Found existing .claude directory"

    if [ -f "$TARGET/CLAUDE.md" ]; then
        EXISTING_CLAUDE_MD=$(cat "$TARGET/CLAUDE.md")
        echo "  - Will preserve your CLAUDE.md content"
    fi

    if [ -f "$TARGET/settings.local.json" ]; then
        cp "$TARGET/settings.local.json" /tmp/claudenv-settings-local.json.bak
        echo "  - Will preserve settings.local.json"
    fi

    echo "  - Will preserve custom skills, commands, and agents"

    echo ""
    read -p "Update claudenv infrastructure? (y/N): " CONFIRM
    if [[ ! "$CONFIRM" =~ ^[Yy]$ ]]; then
        echo "Installation cancelled"
        exit 1
    fi
fi

# Download
echo ""
echo "Downloading Claudenv..."

TEMP_DIR=$(mktemp -d)
trap "rm -rf $TEMP_DIR" EXIT

if command -v curl &> /dev/null; then
    curl -sL "${REPO_URL}/archive/refs/heads/${BRANCH}.tar.gz" | tar -xz -C "$TEMP_DIR"
elif command -v wget &> /dev/null; then
    wget -qO- "${REPO_URL}/archive/refs/heads/${BRANCH}.tar.gz" | tar -xz -C "$TEMP_DIR"
else
    echo "Error: curl or wget required"
    exit 1
fi

DIST="$TEMP_DIR/claudenv-${BRANCH}/dist"

if [ ! -f "$DIST/manifest.json" ]; then
    echo "Error: Missing manifest.json"
    exit 1
fi

mkdir -p "$TARGET"

echo "Installing claudenv framework..."

# Remove deprecated files on update
if [ "$IS_UPDATE" = true ] && [ -f "$TARGET/manifest.json" ]; then
    if command -v jq &> /dev/null; then
        while IFS= read -r file; do
            if [ -f "$TARGET/$file" ]; then
                rm -f "$TARGET/$file"
            fi
        done < <(jq -r '.deprecated[]' "$DIST/manifest.json" 2>/dev/null)
    fi
fi

FRAMEWORK_DIRS="skills commands rules scripts templates agents orchestration"

# Copy framework files using manifest
if command -v jq &> /dev/null; then
    while IFS= read -r file; do
        if [ -f "$DIST/$file" ]; then
            if [ "$IS_SUBPROJECT" = true ]; then
                skip=false
                for dir in $FRAMEWORK_DIRS; do
                    if [[ "$file" == ${dir}/* ]]; then
                        skip=true
                        break
                    fi
                done
                if [ "$skip" = true ]; then
                    continue
                fi
            fi
            mkdir -p "$TARGET/$(dirname "$file")"
            cp "$DIST/$file" "$TARGET/$file"
        fi
    done < <(jq -r '.files[]' "$DIST/manifest.json" 2>/dev/null)
else
    echo "  Note: Install jq for better custom content preservation"
    for dir in commands skills rules scripts templates learning agents orchestration; do
        if [ "$IS_SUBPROJECT" = true ]; then
            skip=false
            for fdir in $FRAMEWORK_DIRS; do
                if [ "$dir" = "$fdir" ]; then
                    skip=true
                    break
                fi
            done
            if [ "$skip" = true ]; then
                continue
            fi
        fi
        if [ -d "$DIST/$dir" ]; then
            mkdir -p "$TARGET/$dir"
            cp -r "$DIST/$dir"/* "$TARGET/$dir"/ 2>/dev/null || true
        fi
    done
fi

cp "$DIST/settings.json" "$TARGET/settings.json"
cp "$DIST/version.json" "$TARGET/version.json"
cp "$DIST/manifest.json" "$TARGET/manifest.json"
[ -f "$DIST/settings.local.json.template" ] && cp "$DIST/settings.local.json.template" "$TARGET/settings.local.json.template"

if [ -f /tmp/claudenv-settings-local.json.bak ]; then
    mv /tmp/claudenv-settings-local.json.bak "$TARGET/settings.local.json"
fi

mkdir -p "$TARGET"/{logs,backups,loop,plans,rca,references,memory,state}

chmod +x "$TARGET/scripts/"*.sh 2>/dev/null || true
chmod +x "$TARGET/scripts/"*.js 2>/dev/null || true

# Migration: v4.x ‚Üí v5.x
if [ "$IS_UPDATE" = true ]; then
    if [ -f "$TARGET/scripts/code-gate.sh" ] && [ -f "$TARGET/scripts/unified-gate.sh" ]; then
        echo "  - Migrating hooks: 3-hook ‚Üí unified-gate"
        rm -f "$TARGET/scripts/code-gate.sh"
        rm -f "$TARGET/scripts/focus-enforce.sh"
        rm -f "$TARGET/scripts/read-before-write.sh"
        rm -f "$TARGET/scripts/tdd-enforce.sh"
        rm -f "$TARGET/scripts/todo-coordinator.sh"
        rm -f "$TARGET/scripts/decision-reminder.sh"
        rm -f "$TARGET/scripts/learning-observer.sh"
    fi
    rm -f "$TARGET/rules/parallel-execution.md"
    rm -f "$TARGET/rules/error-recovery/core.md"
    rm -f "$TARGET/rules/documentation.md"
fi

# Handle CLAUDE.md
if [ -n "$EXISTING_CLAUDE_MD" ]; then
    if echo "$EXISTING_CLAUDE_MD" | grep -qE "@rules/claudenv(.md|/core.md)"; then
        echo "$EXISTING_CLAUDE_MD" > "$TARGET/CLAUDE.md"
    else
        cat > "$TARGET/CLAUDE.md" << EOF
$EXISTING_CLAUDE_MD

## Claudenv Framework

@rules/claudenv/core.md
EOF
    fi
    echo "  - Preserved your CLAUDE.md, added framework import"
else
    cat > "$TARGET/CLAUDE.md" << 'EOF'
# Project Instructions

<!-- Add your project-specific instructions here -->

## Claudenv Framework

@rules/claudenv/core.md
EOF
    echo "  - Created CLAUDE.md with framework import"
fi

if [ ! -f "$TARGET/TODO.md" ] && [ ! -f "./TODO.md" ]; then
    cp "$DIST/TODO.md" "$TARGET/TODO.md" 2>/dev/null || true
    echo "  - Created TODO.md"
fi

LOCAL_SKILLS=$(find "$TARGET/skills" -name "SKILL.md" 2>/dev/null | wc -l | tr -d ' ')
COMMANDS=$(find "$TARGET/commands" -name "*.md" 2>/dev/null | wc -l | tr -d ' ')
AGENTS=$(find "$TARGET/agents" -name "*.md" 2>/dev/null | wc -l | tr -d ' ')

echo ""
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo "  Claudenv Installed!"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo ""
if [ "$IS_SUBPROJECT" = true ]; then
    WORKSPACE_SKILLS=$(find "$WORKSPACE_ROOT/skills" -name "SKILL.md" 2>/dev/null | wc -l | tr -d ' ')
    echo "  üìÅ Subproject config installed"
    echo "  Inherits $WORKSPACE_SKILLS skills from workspace root"
    echo "  $LOCAL_SKILLS local skills"
else
    echo "  $LOCAL_SKILLS skills"
fi
echo "  $COMMANDS commands"
echo "  $AGENTS agents"
echo ""
echo "Next steps:"
echo "  1. Start Claude Code: claude"
echo "  2. Run bootstrap: /ce:init"
echo ""
