# bin/sync

Sync Claude Code infrastructure from workspace to projects.

## Synopsis

```bash
bin/sync [project-name|all] [--dry-run]
```

## Description

The `sync` command distributes Claude Code configuration from the workspace root to individual projects:

- **Rules** - Workspace and stack-specific rules
- **Templates** - Code templates for the project's stack
- **References** - Setup guides and documentation
- **Caddy configs** - Development HTTPS configuration

## Arguments

| Argument | Description |
|----------|-------------|
| `project-name` | Sync a specific project |
| `all` | Sync all projects in `.workspace.yml` |
| `--dry-run` | Preview changes without modifying files |

## Examples

### Show Available Projects

```bash
bin/sync
```

Lists all projects:

```
Usage: bin/sync <project-name|all> [--dry-run]

Projects:
  - brandcmd
  - cmdstack
  - menory
  - monivore
  - myapp
```

### Sync One Project

```bash
bin/sync myapp
```

Output:

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  Syncing: myapp
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  Stack:    nextjs
  Platform: gcp

  Claudenv base: inherited from workspace root

  Syncing workspace files...

  Syncing stack: nextjs

  Syncing platform: gcp

  ────────────────────────────────────────────
  Synced 15 items:
    Rules:      3
    References: 8
    Templates:  4
```

### Sync All Projects

```bash
bin/sync all
```

Syncs every project and regenerates the root `.caddy`:

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  Generating Caddy configuration...
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  Generated .caddy files

  Dev domains:
    https://brandcmd.dev → localhost:3002
    https://cmdstack.dev → localhost:3003
    https://menory.dev → localhost:3004
    https://monivore.dev → localhost:3005
    https://myapp.dev → localhost:3008

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  All projects synced!
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### Preview Changes

```bash
bin/sync myapp --dry-run
```

Shows what would be synced without making changes.

## Sync Layers

Files are synced in order, with later layers overriding earlier ones:

### 1. Claudenv Base (Inherited)

Core framework files are **not copied** to projects. Instead, projects inherit them from the workspace root. This reduces duplication by ~35%.

Files inherited:
- Core skills (`/ce:loop`, `/ce:validate`, etc.)
- Core agents
- Core scripts
- Core rules

### 2. Workspace Common Files

Files shared across all projects:

| Source | Destination |
|--------|-------------|
| `.claude/rules/workspace.md` | `{project}/.claude/workspace/workspace.md` |
| `.claude/settings.json` | `{project}/.claude/settings.json` (if missing) |
| `.claude/references/setup/` | `{project}/.claude/references/setup/` |

### 3. Stack-Specific Files

Based on `stack` in `.workspace.yml`:

```yaml
projects:
  myapp:
    stack: nextjs  # Uses .claude/stacks/nextjs/
```

| Stack | Contents |
|-------|----------|
| `nextjs` | Next.js rules, templates, agents |
| `node` | Node.js rules |
| `python` | Python rules, templates |
| `go` | Go rules |
| `shopify-theme` | Shopify theme rules |

### 4. Platform-Specific Files

Based on `platform` in `.workspace.yml`:

```yaml
projects:
  myapp:
    platform: gcp  # Uses .claude/platforms/gcp/
```

| Platform | Contents |
|----------|----------|
| `gcp` | Cloud Run rules, deployment references |
| `aws` | AWS-specific rules |
| `vercel` | Vercel deployment rules |

### 5. Service-Specific Files

Based on `services` in `.workspace.yml`:

```yaml
projects:
  myapp:
    services:
      - stripe
      - sendgrid
```

Each service adds rules and references from `.claude/services/{service}/`.

## Generated Files

### Project .caddy

Created for each project:

```
# myapp Development Server
# Auto-generated by workspace sync
myapp.dev {
    reverse_proxy localhost:3008
}
```

### Root .caddy

Imports all project configs:

```
# Siquora Development Caddy Config
{
    local_certs
}

import brandcmd/.caddy
import cmdstack/.caddy
import menory/.caddy
import myapp/.caddy
```

### Version Tracking

Creates `{project}/.claude/workspace/version.json`:

```json
{
  "workspace": "1.0.0",
  "base": "2.0.0",
  "stack": "nextjs",
  "platform": "gcp",
  "services": "stripe sendgrid",
  "syncedAt": "2024-01-13T12:00:00Z"
}
```

### Git Hooks

If project has `.git/`, installs:
- `pre-commit` hook from templates

### GitHub Workflows

If project has `.git/`, creates:
- `.github/workflows/test.yml` (if missing)

## Variable Substitution

Templates support these placeholders:

| Placeholder | Value |
|-------------|-------|
| `{project}` | Project name |
| `{package_prefix}` | `@siquora` (from config) |
| `{org}` / `{org_name}` | Organization name |
| `{github}` | GitHub organization |
| `{domain_suffix}` | `.ai` |
| `{dev_domain_suffix}` | `.dev` |

## Running Modes

### Workspace Mode

Run from workspace root to sync any project:

```bash
cd /path/to/siquora
bin/sync myapp
```

### Project Mode

Run from within a project to re-sync itself:

```bash
cd /path/to/siquora/myapp
../bin/sync .
```

## After Syncing

1. **Restart Claude Code** to pick up new rules
2. **Reload Caddy** if `.caddy` files changed:
   ```bash
   caddy reload --config .caddy
   ```

## Files Modified

| File | Purpose |
|------|---------|
| `{project}/.claude/` | Claude Code configuration |
| `{project}/.caddy` | Caddy reverse proxy config |
| `.caddy` | Root Caddy config (sync all) |
| `{project}/config.yaml` | Project config (if missing) |
| `{project}/.git/hooks/pre-commit` | Git hook (if .git exists) |

## Dependencies

- `yq` - YAML parsing
- `jq` - JSON parsing (optional, for version.json)

## See Also

- [bin/create](./bin-create.md) - Create projects (runs sync automatically)
- [bin/upgrade](./bin-upgrade.md) - Check for updates
- [Claudenv Framework](../.claude/rules/claudenv/core.md)
